// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// User model - main participant in competitions
model User {
  id              String  @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  email           String  @unique
  password        String
  phone           String?
  institution     String?
  avatarUrl       String?
  isActive        Boolean @default(true)
  isEmailVerified Boolean @default(false)
  isAdmin         Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  verificationTokens  VerificationToken[]
  passwordResetTokens PasswordResetToken[]
  submissions         Submission[]
  forumPosts          ForumPost[]
  forumComments       ForumComment[]
  submissionMessages  SubmissionMessage[]
  notificationsCreated Notification[]
  notificationReceipts NotificationReceipt[]
  forumPostReactions   ForumPostReaction[]
  forumCommentReactions ForumCommentReaction[]
}

// Email verification tokens
model VerificationToken {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  token     String    @unique
  userId    String    @db.ObjectId
  type      TokenType @default(EMAIL_VERIFICATION)
  expiresAt DateTime
  used      Boolean   @default(false)
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Password reset tokens
model PasswordResetToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  userId    String   @db.ObjectId
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Admin settings for competition management
model AdminSettings {
  id                        String  @id @default(auto()) @map("_id") @db.ObjectId
  currentInterval           Int     @default(1)
  isSubmissionsOpen         Boolean @default(true)
  maxSubmissionsPerInterval Int     @default(3)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_settings")
}

model Competition {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  legacyId        Int      @unique
  title           String
  description     String
  slug            String   @unique
  icon            String?
  color           String?
  deadline        DateTime?
  prizePool       String?
  prizes          Json?
  sections        Json?    // guidelines, problem statements etc.
  isPublished     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  submissions Submission[]

  @@map("competitions")
}

// Submissions for competitions
model Submission {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  competitionId Int // legacy/static numeric ID for backwards compatibility
  competitionDbId String? @db.ObjectId
  userId        String @db.ObjectId
  interval      Int // Current interval when submission was made

  // Submission data
  title       String // Title of the submission
  fileUrl     String // Google Drive link
  description String?

  // Rating and evaluation
  overallScore     Float? @default(0)
  creativityScore  Float? @default(0)
  technicalScore   Float? @default(0)
  aiToolUsageScore Float? @default(0)
  adherenceScore   Float? @default(0)
  impactScore      Float? @default(0)

  // Admin evaluation
  judgeComments String?
  evaluatedBy   String? // Admin/Judge ID or name
  evaluatedAt   DateTime?

  // Status tracking
  status                 SubmissionStatus @default(PENDING)
  isDisqualified         Boolean          @default(false)
  disqualificationReason String?

  // Access verification
  isAccessVerified Boolean @default(false)
  accessCheckError String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  competition Competition? @relation(fields: [competitionDbId], references: [id])
  messages SubmissionMessage[]

  // Composite indexes for efficient queries
  @@index([competitionId, userId, interval])
  @@index([competitionId, interval])
  @@index([userId, competitionId])
  @@index([competitionDbId])
  @@index([status])
  @@map("submissions")
}

model ForumPost {
  id         String          @id @default(auto()) @map("_id") @db.ObjectId
  authorId   String          @db.ObjectId
  title      String
  content    String
  isResolved Boolean         @default(false)
  status     ForumPostStatus @default(OPEN)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  author   User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments ForumComment[]
  reactions ForumPostReaction[]

  @@index([authorId])
  @@map("forum_posts")
}

model ForumComment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  postId    String   @db.ObjectId
  authorId  String   @db.ObjectId
  content   String
  parentId  String?  @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post   ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  reactions ForumCommentReaction[]

  @@index([postId])
  @@index([authorId])
  @@map("forum_comments")
}

model SubmissionMessage {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  submissionId String   @db.ObjectId
  authorId     String   @db.ObjectId
  content      String
  isFromAdmin  Boolean  @default(false)
  createdAt    DateTime @default(now())

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  author     User       @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([authorId])
  @@map("submission_messages")
}

model Notification {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  title              String
  body               String
  targetAll          Boolean  @default(true)
  targetAdminOnly    Boolean  @default(false)
  targetInstitutions String[]
  targetUserIds      String[]
  createdById        String?  @db.ObjectId
  createdAt          DateTime @default(now())

  createdBy User? @relation(fields: [createdById], references: [id])
  receipts  NotificationReceipt[]

  @@index([createdById])
  @@map("notifications")
}

model NotificationReceipt {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  notificationId String   @db.ObjectId
  userId         String   @db.ObjectId
  isRead         Boolean  @default(false)
  readAt         DateTime?
  createdAt      DateTime @default(now())

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
  @@index([userId])
  @@map("notification_receipts")
}

model ForumPostReaction {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  postId    String        @db.ObjectId
  userId    String        @db.ObjectId
  type      ReactionType
  createdAt DateTime      @default(now())

  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
  @@map("forum_post_reactions")
}

model ForumCommentReaction {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  commentId String        @db.ObjectId
  userId    String        @db.ObjectId
  type      ReactionType
  createdAt DateTime      @default(now())

  comment ForumComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([userId])
  @@map("forum_comment_reactions")
}

model Inquiry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String
  subject   String
  message   String?
  createdAt DateTime @default(now())
}

enum TokenType {
  EMAIL_VERIFICATION
  WELCOME_EMAIL
}

enum SubmissionStatus {
  PENDING // Just submitted, awaiting review
  UNDER_REVIEW // Being evaluated by judges
  EVALUATED // Scoring completed
  REJECTED // Doesn't meet criteria
  WINNER // Competition winner
  FINALIST // Top submissions
}

enum ForumPostStatus {
  OPEN
  RESOLVED
}

enum ReactionType {
  LIKE
  SUPPORT
  LOVE
  CELEBRATE
  FUNNY
  ANGRY
  DOWNVOTE
}
